# [ECN] NB-IoT TCP 통신 프로토콜

*2025.03.17 draft Hans Kim*

## 1. 개요

이 문서는 NB-IoT 모듈(Quectel BC95-GV)을 사용하여 서버와 TCP 통신을 수행하는 과정과 관련된 AT 명령어 및 데이터 패킷 구조를 정리한 문서입니다.

## 2. 기본(default) IP 와 포트 변경

| 변경 전 IP      | 변경 후 IP       | 변경 전 포트 | 변경 후 포트 |
| ------------ | ------------- | ------- | ------- |
| 47.56.150.14 | 140.245.72.44 | 5004    | 5004    |

## 3. 통신 흐름

NB-IoT 모듈이 통신을 수행하는 동안, 각 단계별로 성공(`Dx`) 또는 오류(`Bx`) 코드를 LCD 화면에 표시해야 합니다. 이를 통해 사용자는 현재 통신 상태를 쉽게 확인할 수 있으며, 문제 발생 시 오류 원인을 신속하게 파악할 수 있습니다.

- **성공(`Dx`)**: 정상적으로 명령이 수행되었을 경우 표시됩니다.
- **오류(`Bx`)**: 해당 단계에서 문제가 발생한 경우 표시됩니다.

예를 들어, TCP 소켓 생성이 성공하면 `D7`이 표시되고, 실패하면 `B7`이 표시됩니다.

NB-IoT 모듈을 이용하여 서버와 TCP 통신을 수행하는 기본적인 절차는 다음과 같습니다:

1. 네트워크 연결 확인
2. TCP 소켓 생성 및 서버 연결
3. 업스트림 데이터 전송 (디바이스 → 서버)
4. 다운스트림 데이터 수신 (서버 → 디바이스)
5. 소켓 닫기

## 3. AT 명령어 및 패킷 구조

### 3.1 네트워크 연결 확인

| AT 명령어      | 설명             | 성공 코드 | 오류 코드 |
| ----------- | -------------- | ----- | ----- |
| AT          | 기본 AT 명령어 확인   | D1    | B1    |
| ATE1        | 에코 모드 활성화      | D1    | B1    |
| AT+CFUN?    | 장비 기능 상태 확인    | D2    | B2    |
| AT+CIMI     | 국제 가입자 식별번호 확인 | D3    | B3    |
| AT+CEREG?   | 네트워크 등록 상태 확인  | D4    | B4    |
| AT+CGATT?   | 네트워크 연결 상태 확인  | D5    | B5    |
| AT+CGPADDR? | IP 주소 확인       | D6    | B6    |

```plaintext
AT  // 기본 AT 명령어 확인 (D1 / B1)
ATE1  // 에코 모드 활성화 (D1 / B1)
AT+CFUN?  // 장비 기능 상태 확인 (D2 / B2)
AT+CIMI  // 국제 가입자 식별번호 확인 (D3 / B3)
AT+CEREG?  // 네트워크 등록 상태 확인 (D4 / B4)
AT+CGATT?  // 네트워크 연결 상태 확인 (D5 / B5)
```

**응답:** `+CGATT:1` (1이면 네트워크 연결됨)

```plaintext
AT+CGPADDR?  // IP 주소 확인 (D6 / B6)
```

**응답:** `+CGPADDR:0,10.3.42.109` (IP 주소 할당됨)

### 3.2 TCP 소켓 생성 및 서버 연결

| AT 명령어                        | 설명        | 성공 코드 | 오류 코드 |
| ----------------------------- | --------- | ----- | ----- |
| AT+NSOCR=STREAM,6,0,1         | TCP 소켓 생성 | D7    | B7    |
| AT+NSOCO=1,140.245.72.44,5004 | 서버 연결     | D8    | B8    |

```plaintext
AT+NSOCR=STREAM,6,0,1  // TCP 소켓 생성 (D7 / B7)
```

**응답:** `1` (소켓 핸들 ID 반환)

```plaintext
AT+NSOCO=1,140.245.72.44,5004  // 서버 연결 (D8 / B8)
```

**응답:** `OK`

### 3.3 업스트림 데이터 전송 (디바이스 → 서버)

| AT 명령어                          | 설명     | 성공 코드 | 오류 코드 |
| ------------------------------- | ------ | ----- | ----- |
| AT+NSOSD=1,4,01020304,0x100,101 | 데이터 전송 | D9    | B9    |

```plaintext
AT+NSOSD=1,4,01020304,0x100,101  // 데이터 전송 (D9 / B9)
```

**응답:** `1,4` (전송 성공)

### 3.4 다운스트림 데이터 수신 (서버 → 디바이스)

| AT 명령어       | 설명             | 성공 코드 | 오류 코드 |
| ------------ | -------------- | ----- | ----- |
| +NSONMI:1,4  | 서버에서 데이터 수신 알림 | DA    | BA    |
| AT+NSORF=1,4 | 다운스트림 데이터 읽기   | DB    | BB    |

```plaintext
AT+NSORF=1,4  // 데이터 읽기 (DA / BA)
```

### 3.5 소켓 닫기

| AT 명령어     | 설명           | 성공 코드 | 오류 코드 |
| ---------- | ------------ | ----- | ----- |
| AT+NSOCL=1 | 소켓 닫기        | DC    | BC    |
| +NSOCLI:1  | 소켓이 정상적으로 닫힘 | DD    | BD    |

```plaintext
AT+NSOCL=1  // 소켓 닫기 (DC / BC)
```

**응답:** `OK`

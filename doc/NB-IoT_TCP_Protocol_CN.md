# [ECN] NB-IoT TCP 通信协议

*2025.03.17 draft Hans Kim*

## 1. 概述

本文件整理了使用 NB-IoT 模块（Quectel BC95-GV）与服务器进行 TCP 通信的 AT 命令和数据包结构。

## 2. 默认 IP 和端口更改

| 变更前 IP | 变更后 IP | 变更前端口 | 变更后端口 |
| --------- | --------- | --------- | --------- |
| 47.56.150.14 | 140.245.72.44 | 5004 | 5004 |

## 3. 通信流程

在 NB-IoT 模块执行通信过程中，每个步骤都需要在 LCD 屏幕上显示成功 (`Dx`) 或错误 (`Bx`) 代码，以便用户直观了解当前通信状态，并在发生问题时快速排查错误。

- **成功 (`Dx`)**：表示命令成功执行。
- **错误 (`Bx`)**：表示该步骤出现问题。

例如，TCP 套接字创建成功时显示 `D7`，失败时显示 `B7`。

NB-IoT 模块进行 TCP 通信的基本流程如下：

1. 检查网络连接
2. 创建 TCP 套接字并连接服务器
3. 上行数据传输（设备 → 服务器）
4. 下行数据接收（服务器 → 设备）
5. 关闭套接字

## 3. AT 命令与数据包结构

### 3.1 网络连接检查

| AT 命令 | 说明 | 成功代码 | 错误代码 |
| -------- | -------- | ------ | ------ |
| AT | 基本 AT 命令检查 | D1 | B1 |
| ATE1 | 启用回显模式 | D1 | B1 |
| AT+CFUN? | 查询设备功能状态 | D2 | B2 |
| AT+CIMI | 查询国际移动用户识别码 | D3 | B3 |
| AT+CEREG? | 查询网络注册状态 | D4 | B4 |
| AT+CGATT? | 查询网络附着状态 | D5 | B5 |
| AT+CGPADDR? | 查询 IP 地址 | D6 | B6 |

### 3.2 TCP 套接字创建与服务器连接

| AT 命令 | 说明 | 成功代码 | 错误代码 |
| -------- | -------- | ------ | ------ |
| AT+NSOCR=STREAM,6,0,1 | 创建 TCP 套接字 | D7 | B7 |
| AT+NSOCO=1,140.245.72.44,5004 | 连接服务器 | D8 | B8 |

### 3.3 上行数据传输（设备 → 服务器）

| AT 命令 | 说明 | 成功代码 | 错误代码 |
| -------- | -------- | ------ | ------ |
| AT+NSOSD=1,4,01020304,0x100,101 | 发送数据 | D9 | B9 |

### 3.4 下行数据接收（服务器 → 设备）

| AT 命令 | 说明 | 成功代码 | 错误代码 |
| -------- | -------- | ------ | ------ |
| +NSONMI:1,4 | 服务器数据到达通知 | DA | BA |
| AT+NSORF=1,4 | 读取下行数据 | DB | BB |

### 3.5 关闭套接字

| AT 命令 | 说明 | 成功代码 | 错误代码 |
| -------- | -------- | ------ | ------ |
| AT+NSOCL=1 | 关闭套接字 | DC | BC |
| +NSOCLI:1 | 套接字成功关闭 | DD | BD |

## 4. 最终通信流程总结

1. **网络连接检查** (`AT (D1/B1)`, `AT+CFUN? (D2/B2)`, `AT+CIMI (D3/B3)`, `AT+CEREG? (D4/B4)`, `AT+CGATT? (D5/B5)`, `AT+CGPADDR? (D6/B6)`)  
2. **TCP 套接字创建与服务器连接** (`AT+NSOCR (D7/B7)`, `AT+NSOCO (D8/B8)`)  
3. **上行数据传输** (`AT+NSOSD (D9/B9)`)  
4. **服务器下行数据接收** (`+NSONMI (DA/BA)`, `AT+NSORF (DB/BB)`)  
5. **下行数据处理**  
6. **关闭套接字** (`AT+NSOCL (DC/BC)`, `+NSOCLI (DD/BD)`)  

通过上述流程，可以稳定地使用 NB-IoT 进行 TCP 通信。
